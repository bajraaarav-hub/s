rules_version = '2';

/**
 * This ruleset has been simplified to facilitate development by allowing broader access for any authenticated user.
 * It removes strict user-ownership and role-based checks that were causing permission errors during development.
 *
 * Core Philosophy (Simplified):
 * Any authenticated user can read most data to allow for rapid UI development and testing.
 * Writes are still restricted to the authenticated user for their own data to maintain basic data integrity.
 *
 * Data Structure:
 * - /users/{userId}: User profile data.
 * - /books/{bookId}: General book information.
 * - /homework/{homeworkId}: Homework assignments.
 * - /leaderboard/{leaderboardId}: Leaderboard data.
 *
 */
service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------------------------------
    // Helper Functions
    // -------------------------------------------------------------------------

    /**
     * Returns true if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Returns true if the authenticated user's UID matches the provided userId.
     * This is the primary function for enforcing document and path ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    /**
     * Returns true if the document being operated on already exists.
     * CRITICAL for safe update and delete operations.
     */
    function isExistingDoc() {
      return resource != null;
    }
    
    /**
     * A composite check for safe updates and deletes, ensuring the user is the
     * owner AND the document actually exists.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && isExistingDoc();
    }
    
    /**
     * Validates that a subcollection document's 'studentId' field matches the
     * parent user's document ID on creation.
     */
    function hasValidStudentIdOnCreate(userId) {
      return request.resource.data.studentId == userId;
    }

    /**
     * Enforces that the 'studentId' field cannot be changed after creation,
     * preventing a document from being 'moved' between users.
     */
    function isStudentIdImmutable() {
      return request.resource.data.studentId == resource.data.id;
    }
    
    /**
     * Returns true if the requesting user has the 'teacher' role.
     */
    function isTeacher() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher';
    }

    // -------------------------------------------------------------------------
    // Top-Level Collections
    // -------------------------------------------------------------------------
    
    /**
     * @description Users can read any profile and manage their own. User listing is now allowed for any signed in user.
     * @path /users/{userId}
     */
    match /users/{userId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);

      /**
       * @description A user can manage their own leave requests. Teachers can update any request.
       * @path /users/{userId}/leaveRequests/{leaveRequestId}
       */
      match /leaveRequests/{leaveRequestId} {
        allow get: if isSignedIn();
        allow list: if isSignedIn();
        allow create: if isOwner(userId) && hasValidStudentIdOnCreate(userId);
        allow update: if (isExistingOwner(userId) && isStudentIdImmutable()) || isTeacher();
        allow delete: if isExistingOwner(userId);
      }
      
      /**
       * @description A user can read and manage their own AI analysis results.
       * @path /users/{userId}/aiAnalysis/{aiAnalysisId}
       */
      match /aiAnalysis/{aiAnalysisId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId) && hasValidStudentIdOnCreate(userId);
        allow update: if isExistingOwner(userId) && isStudentIdImmutable();
        allow delete: if isExistingOwner(userId);
      }

      /**
       * @description A user can manage the record of their currently detected books.
       * @path /users/{userId}/currentBooks/{currentBooksId}
       */
      match /currentBooks/{currentBooksId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isExistingOwner(userId);
        allow delete: if isExistingOwner(userId);
      }
      
      /**
       * @description Grades are readable by any signed in user and writeable only by teachers.
       * @path /users/{userId}/grades/{gradeId}
       */
      match /grades/{gradeId} {
          allow get: if isSignedIn();
          allow list: if isSignedIn();
          allow create: if isTeacher();
          allow update: if isTeacher();
          allow delete: if isTeacher();
      }

      /**
       * @description Attendance is readable by any signed in user and writeable only by teachers.
       * @path /users/{userId}/attendance/{attendanceId}
       */
      match /attendance/{attendanceId} {
          allow get: if isSignedIn();
          allow list: if isSignedIn();
          allow create: if isTeacher();
          allow update: if isTeacher();
          allow delete: if isTeacher();
      }
    }
    
    // Rule for collection group query
    // Simplified to allow any authenticated user to list leave requests.
    match /{path=**}/leaveRequests/{leaveRequestId} {
      allow list: if isSignedIn();
    }

    /**
     * @description General book information is public and readable by anyone, but cannot be modified by clients.
     * @path /books/{bookId}
     */
    match /books/{bookId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Homework assignments can be read by anyone, but only created/updated by teachers.
     * @path /homework/{homeworkId}
     */
    match /homework/{homeworkId} {
      allow get: if true;
      allow list: if true;
      allow create: if isTeacher();
      allow update: if isTeacher();
      allow delete: if isTeacher();
    }

    /**
     * @description The leaderboard is public and readable by anyone, but cannot be modified by clients.
     * @path /leaderboard/{leaderboardId}
     */
    match /leaderboard/{leaderboardId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}
